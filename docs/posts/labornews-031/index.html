<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="박영삼">
<meta name="dcterms.date" content="2025-08-01">

<title>’심야 장시간 노동’에서 벗어나기, SPC 다음은 어디일까 – park youngsam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">park youngsam</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">News | Column</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://facebook.com"> <i class="bi bi-facebook" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="http://yspark1968.blogspot.com/"> 
<span class="menu-text">Blogger</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">’심야 장시간 노동’에서 벗어나기, SPC 다음은 어디일까</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">교대제</div>
                <div class="quarto-category">노동시간</div>
                <div class="quarto-category">SPC</div>
                <div class="quarto-category">산업안전</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>박영삼 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 1, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#제조-업종별-주야-2교대-현황-살펴보니-식품철강고무제지-다수-업종-광범위-분포" id="toc-제조-업종별-주야-2교대-현황-살펴보니-식품철강고무제지-다수-업종-광범위-분포" class="nav-link active" data-scroll-target="#제조-업종별-주야-2교대-현황-살펴보니-식품철강고무제지-다수-업종-광범위-분포">제조 업종별 주야 2교대 현황 살펴보니 … ‘식품·철강·고무·제지’ 다수 업종 광범위 분포</a>
  <ul class="collapse">
  <li><a href="#주야-12시간-교대-제조업-전반-문제" id="toc-주야-12시간-교대-제조업-전반-문제" class="nav-link" data-scroll-target="#주야-12시간-교대-제조업-전반-문제">주야 12시간 교대 ‘제조업 전반 문제’</a></li>
  <li><a href="#제조업-생산직-2교대-노동자-35만명-저임금고임금-다양한-분포" id="toc-제조업-생산직-2교대-노동자-35만명-저임금고임금-다양한-분포" class="nav-link" data-scroll-target="#제조업-생산직-2교대-노동자-35만명-저임금고임금-다양한-분포">제조업 생산직 2교대 노동자 35만명, 저임금~고임금 다양한 분포</a></li>
  <li><a href="#노조법-개정도-노동자-안전-보장의-좋은-발판" id="toc-노조법-개정도-노동자-안전-보장의-좋은-발판" class="nav-link" data-scroll-target="#노조법-개정도-노동자-안전-보장의-좋은-발판">노조법 개정도 ’노동자 안전 보장’의 좋은 발판</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="박영삼의-통계로-보는-노동" class="level4">
<h4 class="anchored" data-anchor-id="박영삼의-통계로-보는-노동">박영삼의 통계로 보는 노동</h4>
</section>
<section id="제조-업종별-주야-2교대-현황-살펴보니-식품철강고무제지-다수-업종-광범위-분포" class="level2">
<h2 class="anchored" data-anchor-id="제조-업종별-주야-2교대-현황-살펴보니-식품철강고무제지-다수-업종-광범위-분포">제조 업종별 주야 2교대 현황 살펴보니 … ‘식품·철강·고무·제지’ 다수 업종 광범위 분포</h2>
<p>이재명 정부의 초기 노동정책에서 산업안전 문제가 핵심 이슈로 자리매김하고 있다. 이재명 대통령이 취임 후 노동문제와 관련한 첫 방문지로 선택한 곳이 산재 사망사고가 되풀이돼온 SPC그룹 시화공장이었고, 대통령과 관련 부처 장관들의 토론 과정이 공개된 29일 국무회의 안건도 ’산업안전’이 주제였다.</p>
<p>마침 28일 국회 환경노동위원회를 통과한 노동조합 및 노동관계조정법(개정안)도 원청 사업주가 실질적인 지배력을 행사한 경우 사용자 책임을 요구할 수 있도록 하고 있는데, 지금까지 대법원 판례 흐름을 보면 산업안전 분야가 우선 교섭의제로 등장할 가능성이 매우 높다.</p>
<p>SPC 시화공장에서 대통령이 직접 주재했던 현장 간담회에서는 그동안 발생했던 3건의 사망사고가 모두 주야간 2교대 사업장이었고, 심야작업 도중에 사고를 당했다는 점이 중요하게 부각됐다. 그동안 제빵공장의 공정 특성에 따른 안전설비 미비와 사쪽의 미온적 대책 등이 주된 문제로 지목돼 왔다면, 이번에는 장시간 야간노동을 불러온 12시간 맞교대 문제가 핵심 개선과제로 등장했다는 점에서 제조업 전반에 상당한 파장을 미칠 것으로 보인다.</p>
<section id="주야-12시간-교대-제조업-전반-문제" class="level3">
<h3 class="anchored" data-anchor-id="주야-12시간-교대-제조업-전반-문제">주야 12시간 교대 ‘제조업 전반 문제’</h3>
<p>SPC그룹의 경우 2조2교대와 3조2교대 형태로 공장을 운영해 왔다. 전자는 2개조가 주야 맞교대로 5일을 근무한 뒤 이틀을 함께 쉬는 방식이고 후자는 2개조가 주야간을 이어서 근무하는 동안 나머지 1개조가 휴식을 하고 근무조를 순차적으로 번갈아 교대하는 방식이다. 공통적인 것은 한 개 근무조의 근무시간이 12시간으로 장시간 노동을 한다는 점이고 새벽까지 작업이 이어진다는 점이다. 그런데 이 같은 2교대제 방식은 제조업에서 가장 비중이 높은 교대제 형태다.</p>
<p>고용노동부의 고용형태별 근로실태조사(2023년 6월 기준)에서 전국의 1명 이상 사업체 소속 1천695만6천명의 임금노동자 가운데 교대제로 근무하고 있는 노동자는 151만4천명으로 8.9%를 차지한다. 이 가운데 2교대 방식으로 일하는 노동자는 74만6천명으로 전체의 4.4% 비중을 차지한다. 하지만 제조업만 놓고 보면 2교대 근무가 36만1천명으로 9.6%를 차지하며 기능직과 조립직·단순노무직 등 생산직으로 범위를 좁히면 15.7%가 2교대 근무형태로 일하고 있다.</p>
<p>2교대 근무자의 절반에 가까운 48.4%가 제조업에 속해 있고, 그중 생산직이 34만3천명으로 2교대 근무자의 94.8%를 차지한다. 이 통계가 작성된 2008년 이후 전 산업의 2교대 비중은 6.1%에서 4.4%로 줄었지만 제조업 생산직은 2008년 15.4%였던 것이 2023년에도 여전히 15.7% 수준을 유지하고 있다.</p>
<p><img src="교대제1.jpg" class="img-fluid quarto-figure quarto-figure-center"><br>
</p>
</section>
<section id="제조업-생산직-2교대-노동자-35만명-저임금고임금-다양한-분포" class="level3">
<h3 class="anchored" data-anchor-id="제조업-생산직-2교대-노동자-35만명-저임금고임금-다양한-분포">제조업 생산직 2교대 노동자 35만명, 저임금~고임금 다양한 분포</h3>
<p>제조업의 2교대 현황을 업종별로 확인하려면 산업중분류 코드가 제공되는 5명 이상 사업장 임금구조기본통계조사 자료를 이용해야 한다. 제조업의 2교대 생산직 노동자를 25개 업종별로 정리한 것이 &lt;표 2&gt;다.</p>
<p>2023년 6월 기준 제조업에서 2교대로 근무하는 생산직 노동자는 총 35만명 규모로 확인된다. 이들의 월 평균 근로시간은 205.6시간, 초과근로시간은 평균 41.7시간으로 나타났다. 월 평균 임금은 483만원이며 이 중 초과급여가 111만원으로 총임금의 22.9%를 차지한다. 표에서 음영으로 표시한 영역은 총근로시간과 초과근로시간 모두 제조업 평균을 초과하는 경우로, 이 업종은 ’주야 12시간 교대제’로 운영되고 있다고 잠정 분류한 것이다.</p>
<p>예를 들어 SPC그룹이 속한 ’식료품 제조업’은 월 초과근로시간이 44시간을 넘는데 이럴 경우 주당 연장근로시간이 10시간(44×12÷52=10.15)을 넘게 된다. 주 4일 교대근무에서 4일로 나눈 2.5시간씩 연장근로를 할 경우 소정근로 8시간을 포함해서 10.5시간을 일하게 된다. 이때 4시간에 30분씩 휴게시간을 2회 이상 부여해야 하므로 근로시간과 휴게시간 합계가 11.5시간이 돼어 12시간을 모두 채우게 된다. 이렇게 되면 주야 12시간 교대제로 운영하는 것으로 판단할 수 있는 것이다.</p>
<p>반면 ’자동차트레일러제조업’의 경우 월 근로시간이 200시간에 못 미치고 초과근로시간도 40시간에 미달해서 심야근로가 없는 2교대 형태로 운영할 수 있는 여지가 있다. 여기에서 현대자동차가 노사합의로 도입한 ’주간연속 2교대(8+8)’의 영향이 나타난다고 볼 수 있다. 담배제조업과 기타운송장비(조선) 등도 월 근로시간이 180시간대로 주야 2교대가 아니라 주간 2교대에 훨씬 가깝다.</p>
<p><img src="교대제2.jpg" class="img-fluid quarto-figure quarto-figure-center"><br>
</p>
<p>이런 방법으로 음영으로 표시한 영역의 업종들이 12시간 2교대 근무로 간주할 수 있는 업종들이다. 이 가운데 평균임금이 낮은 고무업·식품업·금속가공업·유리광물업·의류업은 ‘저임금·장시간 노동’ 업종으로 분류할 수 있다. 반대로 철강업·제지업 등은 임금수준이 높으면서도 장시간 노동의 2교대 근무체계를 선택한 ‘고임금·장시간 노동’ 업종으로 분류할 수 있다. 저임금·장시간 노동 업종은 초과급여 감소를 보전할 수 있는 임금대책이 필요하지만, 고임금·장시간 노동 업종의 경우 그런 제약조건이 약하다고 할 수 있다.</p>
</section>
<section id="노조법-개정도-노동자-안전-보장의-좋은-발판" class="level3">
<h3 class="anchored" data-anchor-id="노조법-개정도-노동자-안전-보장의-좋은-발판">노조법 개정도 ’노동자 안전 보장’의 좋은 발판</h3>
<p>이런 측면에서 노조조직률도 살펴볼 필요가 있다. 식품업은 노조조직률이 높은데도 저임금의 장시간 노동 상태가 지속돼 왔고, 인쇄업과 섬유업·화학물질제조업은 조직률이 낮은 위험군에 속한다. 철강업(1차 금속제조업)은 조직률이 높고 임금수준도 매우 높은 ‘고임금·장시간 노동’ 업종이다. 그동안 철강산업에서 중대재해가 발생할 때마다 사내하청 노동자들이 주된 희생자가 돼 왔는데, 위험한 장시간 근무체계는 원청의 것을 적용받으면서 임금과 노동조건은 물론 산업안전에 관해서도 아무런 목소리를 낼 수 없었다.</p>
<p>그런 점에서 노동자의 생명과 안전을 중시하는 정책이 적극적으로 추진되고, 원청을 비롯한 실질적 사용자를 대상으로 노조가 교섭을 요구할 수 있는 계기가 마련되고 있는 것은 시사하는 바가 적지 않다. 노동자의 ‘생명과 안전’의 문제를 놓고 ‘단결하고 요구하고 행동할 수 있는’ 발판이 만들어지고 있기 때문이다.</p>
<p>고려대 노동문제연구소 노동데이터센터장 (<a href="youngsampk@gmail.com">youngsampk@gmail.com</a>)</p>


</section>
</section>

</main> <!-- /main -->
<!-- Google tag (gtag.js) -->

<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script><script>

  window.dataLayer = window.dataLayer || [];

  function gtag(){dataLayer.push(arguments);}

  gtag('js', new Date());



  gtag('config', 'G-60S2W83K5X');

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>